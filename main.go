package main

import (
	"bytes"
	"encoding/json"
	"flag"
	"fmt"
	cb "github.com/clearblade/Go-SDK"
	"io/ioutil"
	"os"
)

type Statement struct {
	RunFunc  func(map[string]interface{}, []interface{}) error
	HelpFunc func() string
}

var (
	MsgAddr      string
	PlatformAddr string
	ScriptFile   string
	SetupFile    string
	TeardownFile string
	InfoFile     string
	JustParse    bool
	GetSomeHelp  bool
)

//var funcMap = map[string]func(map[string]interface{}, []interface{}) error{}
var funcMap = map[string]*Statement{}
var scriptVars = map[string]interface{}{}

func init() {
	flag.StringVar(&MsgAddr, "messaging-url", "undefined", "Msg service location")
	flag.StringVar(&PlatformAddr, "platform-url", "undefined", "Platform location")
	flag.StringVar(&ScriptFile, "run", "Do Not Run Script", "Script file to execute")
	flag.StringVar(&SetupFile, "setup", "Do Not Setup", "File to setup system(s)")
	flag.StringVar(&TeardownFile, "teardown", "Do Not Teardown", "File that tears you up")
	flag.StringVar(&InfoFile, "info", "Do Not Get Info", "File generated by setup to be used by the tests")
	flag.BoolVar(&GetSomeHelp, "help", false, "Print out a help string for all statements")
	flag.BoolVar(&JustParse, "parse", false, "Just parse everything and don't execute")
	scriptVars["roles"] = map[string]interface{}{}
	scriptVars["users"] = map[string]interface{}{}
	scriptVars["collections"] = map[string]interface{}{}
	scriptVars["items"] = map[string]interface{}{}
	scriptVars["codeServices"] = map[string]interface{}{}
	scriptVars["codeLibraries"] = map[string]interface{}{}
	scriptVars["triggers"] = map[string]interface{}{}
	scriptVars["timers"] = map[string]interface{}{}
}

func main() {
	flag.Parse()
	cb.CB_ADDR = PlatformAddr
	cb.CB_MSG_ADDR = MsgAddr
	if GetSomeHelp {
		showHelp()
		return
	}
	if SetupFile != "Do Not Setup" && InfoFile != "Do Not Get Info" {
		fatal("Can't have both a setup file and an info file. I know. Confusing.")
	}
	if SetupFile != "Do Not Setup" {
		performSetup(getJSON(SetupFile))
	}
	if InfoFile != "Do Not Get Info" {
		scriptVars = getJSON(InfoFile)
	}
	if ScriptFile != "Do Not Run Script" {
		executeTestScript(getJSON(ScriptFile))
	}
	if TeardownFile != "Do Not Teardown" {
		performTeardown(getJSON(TeardownFile))
	}
}

func getJSON(filename string) map[string]interface{} {
	jsonStr, err := ioutil.ReadFile(filename)
	if err != nil {
		goodbye(err)
	}

	parsed := map[string]interface{}{}
	err = json.Unmarshal(jsonStr, &parsed)
	if err != nil {
		jsonErr := err.(*json.SyntaxError)
		goodbye(fmt.Errorf("%s: (%s, line %d)\n", err.Error(), filename,
			bytes.Count(jsonStr[:jsonErr.Offset], []byte("\n"))+1))
	}
	return parsed
}

func goodbye(err error) {
	fmt.Printf("Exiting with panic error: %s\n", err.Error())
	os.Exit(1)
}
